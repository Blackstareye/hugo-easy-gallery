{{/*  Debugging  */}}
{{/*  <pre>{{ jsonify (dict "indent" "  ") . }}</pre>  */}}


{{ $baseURL := .baseUrl }}
{{ $pathImages := .pathImages }}
{{ $directory := .directory }}
{{ $files := $.files }}
<div> Entering Filemode:</div>
<pre>{{ $directory }}</pre>
<pre>{{ $pathImages }}</pre>
<pre>{{ .Name }}</pre>
<pre> URL: {{ $baseURL }}</pre>


{{- $thumbext := $.thumb }}
	{{- $isthumb := .Name | findRE ($thumbext | printf "%s\\.") }}<!-- is the current file a thumbnail image? -->
	{{- $isimg := lower .Name | findRE "\\.(gif|jpg|jpeg|tiff|png|bmp|webp|avif|jxl)" }}<!-- is the current file an image? -->
	

	{{- if and $isimg (not $isthumb) }}
		{{- $captionFileMd :=  .Name | replaceRE "\\..*" ".md" }}  
		{{- $captionFileTxt := .Name | replaceRE "\\..*" ".txt" }}  
		{{- $absPathCaptionMd := path.Join $pathImages $captionFileMd }} 
		{{- $absPathCaptionTxt := path.Join $pathImages $captionFileTxt }} 
		{{- $captionFileMdE := os.FileExists $absPathCaptionMd }} 
		{{- $captionFileTxtE := os.FileExists $absPathCaptionTxt }} 
		<pre> 
			{{$absPathCaptionMd}} {{os.FileExists $absPathCaptionMd}} <br>
			{{$absPathCaptionTxt}} {{os.FileExists $absPathCaptionTxt}} <br>
		</pre>
		{{$caption := ""}}
		{{- if  $captionFileMdE }}  
			{{ $caption = os.ReadFile $absPathCaptionMd}}
		{{- else if $captionFileTxtE }} 
			<pre> File Detected </pre> 
			{{ $caption = os.ReadFile $absPathCaptionTxt}}
			<pre> {{ $caption }}</pre>
		{{- else  }}
			{{- $caption =  .Name | replaceRE "\\..*" "" | humanize }}<!-- humanized filename without extension -->
		{{- end }}  
		{{- $linkURL := print $baseURL $directory "/" .Name |  absURL }} <!-- absolute URL to hi-res image -->
		{{- $thumb := .Name | replaceRE "(\\.)" ($thumbext | printf "%s.") }}<!-- filename of thumbnail image -->
		{{- $thumbexists := where $files "Name" $thumb }}<!-- does a thumbnail image exist? --> 
		{{- $thumbURL := print $baseURL ($directory) "/" $thumb | absURL }}<!-- absolute URL to thumbnail image -->
		<div class="box">
			<figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
			<div class="img" style="background-image: url('{{ if $thumbexists }}{{ $thumbURL }}{{ else }}{{ $linkURL }}{{ end }}');" >
				<img itemprop="thumbnail" src="{{ if $thumbexists }}{{ $thumbURL }}{{ else }}{{ $linkURL }}{{ end }}" alt="{{ $caption }}" /><!-- <img> hidden if in .gallery -->
			</div>
			<figcaption>
			<p>{{ $caption }}</p>
			</figcaption>
			<a href="{{ $linkURL }}" itemprop="contentUrl"></a><!-- put <a> last so it is stacked on top -->
			</figure>
		</div>
	{{- end }}